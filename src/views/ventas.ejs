<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/_head', { pageTitle: pageTitle }) %>
</head>

<body>
    <div class="layout">
        <%- include('partials/_sidebarGlobal', { user: user, activeMenu: activeMenu }) %>
            <div class="main-content">
                <%- include('partials/_navbar', { user: user }) %>
                    <div class="content-wrapper p-3">
                        <div class="container-fluid">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h1 class="h3"> <%= pageTitle ? pageTitle.split(' - ')[0] : ' Usuarios' %></h1>
                                    <!-- BotÃ³n para abrir el modal -->
                                    <button type="button" class="btn btn-sm btn-neo-agregar" data-bs-toggle="modal" data-bs-target="#modalRegiVentas">
                                        <i class="bi bi-plus-circle me-1"></i>Registrar Venta
                                    </button>
                            </div>
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-search fs-5 me-3"></i>
                                        <input type="text" id="buscador" class="form-control" placeholder="Buscar ventas..." onkeyup="filtrarVentas()">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped table-sm" id="tablaVentasNeoPOS">
                                            <thead>
                                                <tr class="text-center">
                                                    <th>ID</th>
                                                    <th>Cliente</th>
                                                    <th>Vendedor</th>
                                                    <th>Tipo Comprobante</th>
                                                    <th>Serie</th>
                                                    <th>#Compobante</th>
                                                    <th>Valor Total</th>
                                                    <th>Observaciones</th>
                                                    <th>Estado</th>
                                                    <th>DescargarFactura</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-ventas">
                                                <% ventas.forEach(venta=> { %>
                                                    <tr class="text-center">
                                                        <td><%= venta.id_venta %></td>
                                                        <td><%= venta.tercero.nombre_razon_social %></td>
                                                        <td><%= venta.usuario.nombre_completo %></td>
                                                        <td><%= venta.tipo_comprobante %></td>
                                                        <td><%= venta.serie_comprobante %></td>
                                                        <td><%= venta.numero_comprobante %></td>
                                                        <td><%= venta.total_venta_final %></td>
                                                        <td><%= venta.observaciones %></td>
                                                        <td><%= venta.estado_venta %></td>
                                                        <td><a href="/ventas/pdf/<%= venta.id_venta %>" target="_blank" class="btn btn-sm btn-neo-agregar">ðŸ“„Factura </a></td>
                                                    </tr>
                                                    <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>                               
                            </div>
                        </div>
                    </div>
            </div>
    </div>
    <div class="modal fade" id="modalRegiVentas" tabindex="-1" aria-labelledby="modalRegiVentasLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRegiVentasLabel">
                        <i class="bi bi-cart-plus"></i> Nueva Venta
                    </h5>
                </div>
                <form id="formRegiVentas">
                    <div class="modal-body">
                        <!-- InformaciÃ³n general de la venta -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_tercero_cliente" class="form-label">Cliente *</label>
                                    <select class="form-select" id="id_tercero_cliente" name="id_tercero_cliente" required>
                                        <option value="">Seleccionar cliente...</option>
                                        <% terceros.forEach(tercero => { %>
                                            <option value="<%= tercero.id_tercero %>"><%= tercero.nombre_razon_social %></option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tipo_comprobante" class="form-label">Tipo Comprobante *</label>
                                    <input class="form-select" id="tipo_comprobante" name="tipo_comprobante" required>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="serie_comprobante" class="form-label">Serie</label>
                                    <input type="text" class="form-control" id="serie_comprobante" name="serie_comprobante" placeholder="Ej: B001">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="numero_comprobante" class="form-label">NÃºmero *</label>
                                    <input type="text" class="form-control" id="numero_comprobante" name="numero_comprobante" required placeholder="Ej: 00001234">
                                </div>
                            </div>
                        </div>

                        <!-- SecciÃ³n de productos -->
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-box"></i> Productos de la Venta</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <select class="form-select" id="selectArticulo">
                                    <option value="">Seleccionar producto...</option>
                                    <% articulos.forEach(articulo => { %>
                                        <option value="<%= articulo.id_articulo %>" 
                                                data-nombre="<%= articulo.nombre %>"
                                                data-precio="<%= articulo.precio_venta_neto %>"
                                                data-stock="<%= articulo.stock_actual %>"
                                                data-impuesto="<%= articulo.aplica_impuesto %>">
                                            <%= articulo.nombre %> - $<%= articulo.precio_venta_neto %> (Stock: <%= articulo.stock_actual %>)
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" id="cantidadArticulo" placeholder="Cantidad" min="1" step="0.01">
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" id="descuentoArticulo" placeholder="% Descuento" min="0" max="100" step="0.01">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-neo-agregar w-100" onclick="agregarProducto()">
                                    <i class="bi bi-plus"></i> Agregar
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de productos agregados -->
                        <div class="table-responsive mb-3">
                            <table class="table table-sm" id="tablaProductos">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Base</th>
                                        <th>% Desc.</th>
                                        <th>Precio Final</th>
                                        <th>Subtotal</th>
                                        <th>Impuesto</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productosVenta">
                                </tbody>
                            </table>
                        </div>
                        
                        <hr>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="tasa_impuesto_general_aplicada" class="form-label">Tasa Impuesto General (%)</label>
                                    <input type="number" step="0.01" class="form-control" id="tasa_impuesto_general_aplicada" name="tasa_impuesto_general_aplicada" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="total_descuentos" class="form-label">Descuentos Adicionales</label>
                                    <input type="number" step="0.01" class="form-control" id="total_descuentos" name="total_descuentos" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="total_impuestos_venta" class="form-label">Impuestos Adicionales</label>
                                    <input type="number" step="0.01" class="form-control" id="total_impuestos_venta" name="total_impuestos_venta" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subtotal_venta_neto" class="form-label">Subtotal Neto</label>
                                    <input type="number" step="0.01" class="form-control" id="subtotal_venta_neto" name="subtotal_venta_neto" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="total_venta_final" class="form-label"><strong>Total Final</strong></label>
                                    <input type="number" step="0.01" class="form-control fw-bold fs-5" id="total_venta_final" name="total_venta_final" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-neo-agregar">
                            <i class="bi bi-save"></i> Registrar Venta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
        <%- include('partials/_scripts') %>
        <script src="/js/ventas.js"></script>
</body>

</html>